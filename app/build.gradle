plugins {
    id 'application'
    id 'jacoco'
}

group = 'cfggen'
version = '1.0.0'

repositories {
    mavenCentral()
}

// 将版本号统一管理，方便后续升级
def versions = [
        fastjson2: '2.0.61',
        poi      : '5.5.0',
        fastexcel: '0.19.0',
        antlr    : '4.13.1'
]

dependencies {
    // 核心业务依赖
    implementation "org.antlr:antlr4-runtime:${versions.antlr}"
    implementation "org.dhatim:fastexcel:${versions.fastexcel}"
    implementation "org.dhatim:fastexcel-reader:${versions.fastexcel}"
    implementation 'de.siegmar:fastcsv:2.2.2'
    implementation "com.alibaba.fastjson2:fastjson2:${versions.fastjson2}"
    implementation 'io.github.sashirestela:simple-openai:3.8.2'
    implementation "gg.jte:jte:3.2.1"
    implementation "org.apache.poi:poi:${versions.poi}"
    implementation "org.apache.poi:poi-ooxml:${versions.poi}"
    implementation 'io.github.codeboyzhou:mcp-declarative-java-sdk:0.9.0'
    implementation 'org.apache.commons:commons-text:1.14.0'

    // 测试依赖
    testImplementation 'org.junit.jupiter:junit-jupiter:5.9.1'
    testRuntimeOnly "org.junit.platform:junit-platform-launcher"
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

// 统一配置编译参数
tasks.withType(JavaCompile).configureEach {
    options.encoding = "UTF-8"
    options.compilerArgs << "-Xlint:unchecked" << "-Xlint:deprecation"
}

application {
    mainClass = 'configgen.gen.Main'
    // 解决 Java 21 下 Fastjson2 触发的 Unsafe 警告
    applicationDefaultJvmArgs = ["--add-opens=java.base/sun.misc=ALL-UNNAMED"]
}

jar {
    manifest {
        attributes 'Main-Class': 'configgen.gen.Main'
    }
}

/**
 * 改进后的 FatJar 任务
 * 1. 自动包含 copyGenJavaSources 的输出
 * 2. 排除依赖包中的签名文件，防止 SecurityException
 */
tasks.register('fatJar', Jar) {
    group = 'build'
    description = '构建包含所有依赖的的可执行 JAR'
    archiveFileName = 'cfggen.jar'

    duplicatesStrategy = DuplicatesStrategy.EXCLUDE

    // 包含主程序编译输出
    from sourceSets.main.output

    // 包含所有运行时依赖的解压内容
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    } {
        // 必须排除这些签名文件，否则 java -jar 运行时会报错
        exclude "META-INF/*.SF"
        exclude "META-INF/*.DSA"
        exclude "META-INF/*.RSA"
    }

    manifest.from jar.manifest
}

/**
 * 改进后的资源拷贝任务
 * 使用 layout.buildDirectory 替代硬编码路径
 */
tasks.register('copyGenJavaSources', Copy) {
    description = '复制模板源码到 resources 目录供运行时调用'

    from('src/main/java/configgen/genjava') {
        include 'Schema.java',
                'SchemaBean.java',
                'SchemaCompatibleException.java',
                'SchemaEnum.java',
                'SchemaInterface.java',
                'SchemaList.java',
                'SchemaMap.java',
                'SchemaPrimitive.java',
                'SchemaRef.java',
                'SchemaDeserializer.java',
                'ConfigErr.java',
                'ConfigInput.java',
                'BytesInspector.java'
    }
    // 打包后的路径：support/configgen/genjava/
    into layout.buildDirectory.dir("resources/main/support/configgen/genjava")
}

// 挂载任务依赖链
tasks.named('processResources') {
    dependsOn copyGenJavaSources
}

tasks.named('fatJar') {
    dependsOn copyGenJavaSources
}

// 测试与覆盖率配置
tasks.named('test') {
    useJUnitPlatform()
    finalizedBy jacocoTestReport
}

jacocoTestReport {
    dependsOn test
    reports {
        csv.required = true
        xml.required = true
        html.outputLocation = layout.buildDirectory.dir('jacocoHtml')
    }
}