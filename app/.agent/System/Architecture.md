# 架构设计

## 整体架构

cfggen 采用以Context为核心的模块化架构，所有组件都通过Context进行交互和管理。系统围绕配置数据的解析、处理和代码生成展开，支持多种数据源和输出语言。

```
┌─────────────────────────────────────────────────────────────┐
│                        configgen                            │
├─────────────┬─────────────┬─────────────────┬───────────────┤
│     ctx     │   schema    │      data       │     value     │
│   (核心)    │  (Schema)   │   (数据读取)    │   (值处理)    │
├─────────────┼─────────────┼─────────────────┼───────────────┤
│  i18n       │   tool      │ editorserver    │     util      │
│ (国际化)    │  (工具)     │  (编辑器服务)   │   (工具类)    │
├─────────────┼─────────────┼─────────────────┼───────────────┤
│  genjava    │   gencs     │    genjson      │    genlua     │
│ (Java生成)  │ (C#生成)    │  (JSON生成)     │  (Lua生成)    │
├─────────────┼─────────────┼─────────────────┼───────────────┤
│   gents     │   gengo     │                 │               │
│ (TS生成)    │ (Go生成)    │                 │               │
└─────────────┴─────────────┴─────────────────┴───────────────┘
         │              │              │              │
         └──────────────┼──────────────┼──────────────┘
                        │              │
                ┌───────▼───────┐ ┌─────▼─────┐
                │   cfgeditor   │ │    LLM    │
                │   (编辑器)    │ │ (AI服务)  │
                └───────────────┘ └───────────┘
```

## 核心模块

### 1. 上下文管理模块 (ctx) - 核心控制器
作为系统的核心，负责协调所有其他模块的交互和数据流。

- **Context**：全局上下文管理
- **DirectoryStructure**：目录结构管理
- **ExplicitDir**：显式目录配置
- **HeadRow**：表头行处理
- **模块协调**：管理schema、data、value等模块的交互

### 2. Schema管理模块 (schema)
负责配置Schema的定义、解析和验证。

- **schema.cfg**：CFG格式Schema解析
- **XML解析**：XML格式Schema支持
- **类型系统**：结构体、接口、表定义管理
- **验证机制**：Schema完整性验证

### 3. 数据读取模块 (data)
负责从不同格式的文件中读取配置数据。

- **ExcelReader**：Excel文件读取
- **ReadCsv**：CSV文件读取
- **ReadByFastExcel**：高性能Excel读取
- **ReadByPoi**：POI库Excel读取（可选）
- **JSON读取**：JSON格式数据读取

### 4. 值处理模块 (value)
负责配置值的解析、转换和验证。

- **值解析**：字符串到具体类型的转换
- **类型转换**：自动类型推断和转换
- **约束验证**：取值范围、必填等约束检查

### 5. 国际化模块 (i18n)
支持多语言配置和术语管理。

- **术语检查**：多语言术语验证
- **语言切换**：运行时语言切换支持
- **兼容性检查**：术语版本兼容性验证

### 6. 工具模块 (tool)
提供各种工具类和辅助功能。

- **ValueSearcher**：值搜索工具
- **BinaryToText**：二进制到文本转换
- **XmlToCfg**：XML到CFG格式转换
- **数据验证**：配置数据完整性检查

### 7. 编辑器服务模块 (editorserver)
为外部编辑器提供配置服务。

- **HTTP服务**：提供RESTful API
- **实时更新**：配置变更实时推送
- **编辑器集成**：与cfgeditor的通信接口

### 8. 代码生成器模块
针对不同编程语言的代码生成实现。

- **genjava**：Java代码生成，支持sealed接口、数据类、工具类
- **gencs**：C#代码和字节码生成，支持.NET平台
- **genjson**：JSON格式生成，支持AI集成和OpenAI API
- **genlua**：Lua脚本生成，内存优化，适合游戏配置
- **gents**：TypeScript代码生成，支持接口定义和类型安全
- **gengo**：Go语言代码生成，支持模块结构和标准库兼容

## 数据流和模块交互

### 核心数据流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ schema  │───▶│  data   │───▶│  value  │───▶│   gen   │
│ (解析)  │    │ (读取)  │    │ (处理)  │    │ (生成)  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
     └──────────────┼──────────────┼──────────────┘
                    │              │
              ┌─────▼──────────────▼─────┐
              │          ctx             │
              │       (核心协调)         │
              └──────────────────────────┘
```

### 配置处理流程

1. **初始化阶段**
   - Context创建并初始化所有模块
   - 配置目录结构和数据源
   - 设置国际化选项

2. **Schema处理阶段**
   - schema模块解析.cfg/.xml文件
   - 构建类型系统和关系网络
   - 验证Schema完整性

3. **数据读取阶段**
   - data模块基于Schema定义读取CSV/Excel/JSON文件
   - 解析表头和数据结构
   - 转换为内部数据表示

4. **值处理阶段**
   - value模块根据Schema类型处理数据
   - 类型推断和转换
   - 约束验证和错误检查

5. **代码生成阶段**
   - 选择目标语言生成器
   - 应用模板生成代码
   - 输出到指定目录

### 模块依赖关系

- **ctx → schema**：管理Schema解析和验证
- **ctx → data**：管理数据读取和处理
- **ctx → value**：提供值处理访问接口
- **生成器 → ctx**：通过Context访问核心功能
- **tool → ctx**：通过Context使用工具功能
- **i18n → ctx**：通过Context处理国际化
- **editorserver → ctx**：使用Context服务编辑器
- **genjson → LLM**：使用AI服务进行JSON生成


## 扩展性设计

### 模块化扩展机制

#### 添加新数据源
1. 实现对应的Reader类
2. 在Context中注册
3. 更新Schema解析支持

#### 添加新语言生成器
1. 继承Generator基类
2. 实现generate方法
3. 在Generators中注册
4. 添加对应的模板文件

#### 添加新工具功能
1. 实现工具类
2. 通过Context提供访问接口
3. 集成到命令行参数

### 配置系统
- **命令行参数**：丰富的命令行选项支持
- **系统属性**：JVM系统属性配置
- **环境变量**：环境变量配置支持
- **文件配置**：配置文件支持

### 外部集成
- **编辑器集成**：通过editorserver模块支持cfgeditor
- **AI服务集成**：通过genjson模块支持LLM服务
- **国际化服务**：通过i18n模块支持多语言管理

## 性能考虑

### 内存优化
- **缓存机制**：使用CachedIndentPrinter缓存输出流减少IO操作
- **大文件处理**：支持大文件分块处理，避免内存溢出
- **增量生成**：增量代码生成支持，避免重复处理
- **内存监控**：性能分析支持内存使用监控，支持GC后内存分析
- **流式处理**：使用流式读取处理大文件，降低内存占用

### 处理效率
- **并行处理**：支持并行数据读取和模板处理
- **模板优化**：JTE模板预编译和缓存，提高生成速度
- **重复计算**：缓存重复计算结果，避免重复解析
- **FastExcel**：使用高性能FastExcel库，比Apache POI快3-5倍
- **CSV优化**：使用FastCSV库，支持流式处理大CSV文件

### 生成优化
- **代码压缩**：Lua生成支持内存优化，减少运行时内存占用
- **类型安全**：Java生成支持sealed接口，提供编译时类型检查
- **引用优化**：外键引用性能优化，支持快速查找
- **模板复用**：模板文件复用，避免重复模板编译
- **输出优化**：使用缓存输出流，减少文件IO操作

### 性能监控
- **详细分析**：支持-p和-pp参数进行性能分析
- **内存跟踪**：监控内存使用情况和GC行为
- **时间统计**：统计各阶段处理时间，识别性能瓶颈
- **资源管理**：自动管理文件句柄和内存资源

## 错误处理

### 异常体系
- **统一格式**：统一的错误报告格式
- **详细跟踪**：详细的堆栈跟踪信息
- **用户友好**：用户友好的错误信息显示
- **分级报告**：支持不同级别的详细程度

### 验证机制
- **数据完整性**：配置数据完整性检查
- **Schema一致性**：Schema定义一致性验证
- **类型安全**：类型安全保证机制
- **引用完整性**：外键引用完整性验证

### 恢复机制
- **优雅降级**：部分错误下的继续处理
- **错误隔离**：模块间错误隔离
- **重试机制**：支持重试和恢复操作

---
*最后更新：2025-11-05*